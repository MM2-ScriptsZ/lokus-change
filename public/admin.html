<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LOKUS CHANGE â€“ Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;font-family:Inter,Arial,sans-serif}
body{
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#0b0b0b;
  color:#fff;
}
.card{
  width:420px;
  background:#2f2f2f;
  padding:24px;
  border-radius:10px;
  box-shadow:0 0 30px rgba(0,0,0,.6);
}
h1{margin-top:0;text-align:center}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:6px;
  border:none;
}
input{background:#1e1e1e;color:#fff}
button{background:#0aa3ff;color:#fff;font-weight:bold;cursor:pointer}
button:hover{opacity:.9}
.error{color:#ff5555;margin-top:10px;font-size:13px}
.hidden{display:none}

table{
  width:100%;
  margin-top:15px;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #444;
  text-align:left;
}
th{color:#0aa3ff}
.action{
  background:#444;
  margin-right:4px;
  padding:4px 6px;
  font-size:12px;
}
.action.danger{background:#ff4444}
.action.warn{background:#ffaa00;color:#000}
</style>
</head>

<body>

<div class="card">

  <!-- LOGIN -->
  <div id="loginBox">
    <h1>Admin Login</h1>
    <input id="secret" type="password" placeholder="ADMIN SECRET">
    <button onclick="login()">Login</button>
    <div id="loginError" class="error"></div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden">
    <h1>Admin Dashboard</h1>

    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Expire</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="keys"></tbody>
    </table>

    <button style="margin-top:15px;background:#666" onclick="logout()">Logout</button>
  </div>

</div>

<script>
let adminSession = localStorage.getItem("admin_session") || null;

if (adminSession) {
  showDashboard();
  loadKeys();
}

async function login() {
  loginError.textContent = "";

  const res = await fetch("/api/admin-login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ secret: secret.value })
  });

  const data = await res.json();

  if (!data.ok) {
    loginError.textContent = "Invalid admin secret";
    return;
  }

  adminSession = data.session;
  localStorage.setItem("admin_session", adminSession);

  showDashboard();
  loadKeys();
}

function showDashboard() {
  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

async function loadKeys() {
  const res = await fetch("/api/admin-list-keys", {
    headers: { "x-admin-session": adminSession }
  });

  const data = await res.json();
  const tbody = document.getElementById("keys");
  tbody.innerHTML = "";

  Object.entries(data.keys).forEach(([key, k]) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${key}</td>
      <td>${new Date(k.expiresAt).toLocaleString()}</td>
      <td>${k.banned ? "BANNED" : "ACTIVE"}</td>
      <td>
        <button class="action danger" onclick="banKey('${key}')">Ban</button>
        <button class="action warn" onclick="resetHWID('${key}')">Reset HWID</button>
        <button class="action" onclick="extend('${key}')">+24h</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function banKey(key) {
  if (!confirm("Ban/unban this key?")) return;
  await fetch("/api/admin-ban-key", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-session": adminSession
    },
    body: JSON.stringify({ key })
  });
  loadKeys();
}

async function resetHWID(key) {
  if (!confirm("Reset HWID for this key?")) return;
  await fetch("/api/admin-reset-hwid", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-session": adminSession
    },
    body: JSON.stringify({ key })
  });
  loadKeys();
}

async function extend(key) {
  await fetch("/api/admin-extend-by-hwid", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-session": adminSession
    },
    body: JSON.stringify({ hwid: "", minutes: 1440 })
  });
  loadKeys();
}

function logout() {
  localStorage.removeItem("admin_session");
  location.reload();
}
</script>

</body>
</html>
